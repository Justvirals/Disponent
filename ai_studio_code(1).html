<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR & Fleet Pro System</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.29.3/date_fns.min.js"></script>
    
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #0a58ca;
            --bg-color: #f8f9fa;
            --white: #ffffff;
            --text-dark: #212529;
            --text-light: #6c757d;
            --danger: #dc3545;
            --success: #198754;
            --warning: #ffc107;
            --whatsapp: #25D366;
            --shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.08);
            --transition: all 0.2s ease-in-out;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-dark);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        body[lang="de"] { font-family: 'Roboto', sans-serif; }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: var(--white);
            height: 100%;
            display: flex;
            flex-direction: column;
            border-inline-end: 1px solid #dee2e6;
            box-shadow: var(--shadow);
            z-index: 100;
        }

        .logo-area {
            height: 75px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary-color);
            border-bottom: 1px solid #dee2e6;
            background: linear-gradient(to bottom right, #ffffff, #f0f8ff);
        }

        .nav-links { flex: 1; padding: 20px 15px; overflow-y: auto; }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 5px;
            border-radius: 8px;
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }

        .nav-item:hover, .nav-item.active {
            background-color: #e7f1ff;
            color: var(--primary-color);
            transform: translateX(-3px);
        }
        body[dir="ltr"] .nav-item:hover { transform: translateX(3px); }

        .nav-item i { margin-inline-end: 12px; width: 25px; text-align: center; font-size: 1.2rem; }

        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        .header {
            height: 75px;
            background-color: var(--white);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            border-bottom: 1px solid #dee2e6;
        }

        .date-badge {
            font-size: 0.9rem;
            color: var(--primary-color);
            background: #e7f1ff;
            padding: 8px 20px;
            border-radius: 30px;
            font-weight: bold;
        }

        .content-area { flex: 1; padding: 30px; overflow-y: auto; }

        /* Cards & Tables */
        .card {
            background: var(--white);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            border: 1px solid #edf2f4;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 4px solid var(--primary-color);
        }

        .btn {
            padding: 9px 18px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            font-family: inherit;
        }

        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--primary-color); color: var(--white); }
        .btn-primary:hover { background: var(--secondary-color); }
        .btn-danger { background: var(--danger); color: var(--white); }
        .btn-whatsapp { background: var(--whatsapp); color: var(--white); }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }

        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; }
        th, td { padding: 15px; text-align: right; border-bottom: 1px solid #f1f3f5; }
        body[dir="ltr"] th, body[dir="ltr"] td { text-align: left; }
        th { color: var(--text-light); font-weight: 700; background: #f8f9fa; font-size: 0.95rem; }
        tr:hover { background-color: #f8f9fa; }
        
        .time-badge {
            font-size: 0.8rem;
            color: #666;
            background: #eee;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 5px;
        }

        /* Forms & Modal */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center;
            z-index: 1000; backdrop-filter: blur(4px);
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--white); width: 500px; padding: 30px;
            border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 700; font-size: 0.9rem; }
        .form-control {
            width: 100%; padding: 12px; border: 1px solid #dee2e6;
            border-radius: 8px; font-family: inherit; font-size: 1rem;
            transition: var(--transition);
        }
        .form-control:focus { border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(13,110,253,0.1); }
        
        .status-tag { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .tag-green { background: #d1e7dd; color: #0f5132; }
        .tag-red { background: #f8d7da; color: #842029; }
        .tag-yellow { background: #fff3cd; color: #664d03; }

        /* Calendar Styles */
        .calendar-container {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .calendar-day {
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }
        .calendar-day:hover {
            background: #e7f1ff;
        }
        .calendar-day.has-event {
            background: #d1e7dd;
            color: #0f5132;
            font-weight: bold;
        }
        .calendar-day.today {
            background: var(--primary-color);
            color: white;
        }

        /* Notification Styles */
        .notification-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1001;
            display: none;
        }
        .notification-header {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
            color: var(--primary-color);
        }
        .notification-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f1f3f5;
            cursor: pointer;
        }
        .notification-item:hover {
            background: #f8f9fa;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        /* Report Styles */
        .report-container {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .report-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .report-card h4 {
            color: var(--text-light);
            margin-bottom: 5px;
        }
        .report-card .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

    </style>
</head>
<body data-lang="ar">

    <div class="sidebar">
        <div class="logo-area">
            <i class="fa-solid fa-briefcase"></i>&nbsp; WORKSPACE
        </div>
        <div class="nav-links">
            <div class="nav-item active" onclick="navigate('dashboard')">
                <i class="fa-solid fa-chart-pie"></i> <span data-key="dashboard">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
            </div>
            <div class="nav-item" onclick="navigate('vehicles')">
                <i class="fa-solid fa-truck"></i> <span data-key="vehicles">Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª</span>
            </div>
            <div class="nav-item" onclick="navigate('employees')">
                <i class="fa-solid fa-user-group"></i> <span data-key="employees">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span>
            </div>
            <div class="nav-item" onclick="navigate('tasks')">
                <i class="fa-solid fa-list-check"></i> <span data-key="tasks">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</span>
            </div>
            <div class="nav-item" onclick="navigate('salaries')">
                <i class="fa-solid fa-wallet"></i> <span data-key="salaries">Ø§Ù„Ø±ÙˆØ§ØªØ¨</span>
            </div>
            <div class="nav-item" onclick="navigate('bonuses')">
                <i class="fa-solid fa-gift"></i> <span data-key="bonuses">Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª</span>
            </div>
            <div class="nav-item" onclick="navigate('leaves')">
                <i class="fa-solid fa-plane"></i> <span data-key="leaves">Ø§Ù„Ø¹Ø·Ù„ ÙˆØ§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</span>
            </div>
            <div class="nav-item" onclick="navigate('issues')">
                <i class="fa-solid fa-triangle-exclamation"></i> <span data-key="issues">Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ ÙˆØ§Ù„Ø´ÙƒØ§ÙˆÙ‰</span>
            </div>
            <div class="nav-item" onclick="navigate('schedule')">
                <i class="fa-solid fa-calendar-days"></i> <span data-key="schedule">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„</span>
            </div>
            <div class="nav-item" onclick="navigate('alerts')">
                <i class="fa-brands fa-whatsapp"></i> <span data-key="alerts">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</span>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <div><h2 id="page-header" style="font-size:1.5rem;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2></div>
            <div style="display:flex; align-items:center; gap:15px;">
                <div class="date-badge" id="current-date">--/--/----</div>
                <button class="btn" style="background:#f1f3f5; position: relative;" onclick="toggleNotifications()">
                    <i class="fa-solid fa-bell"></i>
                    <span class="notification-badge" id="notification-count" style="display: none;">0</span>
                </button>
                <button class="btn" style="background:#f1f3f5;" onclick="toggleLanguage()">
                    <i class="fa-solid fa-globe"></i> <span id="lang-text">Deutsch</span>
                </button>
            </div>
        </div>

        <div class="content-area" id="content">
            <!-- Dynamic Content -->
        </div>
    </div>

    <!-- Notification Panel -->
    <div class="notification-panel" id="notification-panel">
        <div class="notification-header">
            <span>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span>
            <span class="notification-badge" id="notification-count">0</span>
        </div>
        <div id="notification-list"></div>
    </div>

    <!-- Universal Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-bottom:25px; color:var(--primary-color);">Ø¥Ø¶Ø§ÙØ©</h2>
            <form id="modal-form">
                <div id="modal-fields"></div>
                <div style="text-align: end; margin-top: 30px; display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="btn" style="background:#f1f3f5; color:#495057;" onclick="closeModal()" data-key="cancel">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn btn-primary" data-key="save">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- Translations ---
        const translations = {
            ar: {
                dashboard: "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",
                vehicles: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª",
                employees: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",
                tasks: "Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„Ø¹Ù…Ù„",
                salaries: "Ø§Ù„Ø±ÙˆØ§ØªØ¨",
                bonuses: "Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª",
                leaves: "Ø³Ø¬Ù„ Ø§Ù„Ø¹Ø·Ù„",
                issues: "Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ ÙˆØ§Ù„Ø´ÙƒØ§ÙˆÙ‰",
                alerts: "Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§ØªØ³Ø§Ø¨",
                schedule: "Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„",
                cancel: "Ø¥Ù„ØºØ§Ø¡",
                save: "Ø­ÙØ¸",
                add: "Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯",
                name: "Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù",
                phone: "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ",
                role: "Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ",
                plate: "Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©",
                km: "Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª (KM)",
                lastOil: "Ø¢Ø®Ø± ØªØºÙŠÙŠØ± Ø²ÙŠØª",
                oilLimit: "Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù„Ø²ÙŠØª",
                oilRem: "Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø²ÙŠØª",
                maintenance: "Ø§Ù„ØµÙŠØ§Ù†Ø©",
                driver: "Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„",
                stops: "Ø§Ù„Ù…Ø­Ø·Ø§Øª ÙˆØ®Ø· Ø§Ù„Ø³ÙŠØ±",
                date: "Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª",
                status: "Ø§Ù„Ø­Ø§Ù„Ø©",
                actions: "ØªØ­ÙƒÙ…",
                desc: "Ø§Ù„ÙˆØµÙ / Ø§Ù„ØªÙØ§ØµÙŠÙ„",
                amount: "Ø§Ù„Ù…Ø¨Ù„Øº",
                type: "Ø§Ù„Ù†ÙˆØ¹",
                bonus: "Ù…ÙƒØ§ÙØ£Ø© (+)",
                salary: "Ø±Ø§ØªØ¨",
                deduction: "Ø®ØµÙ… / Ø¹Ù‚ÙˆØ¨Ø© (-)",
                no_description: "Ø¨Ø¯ÙˆÙ† ÙˆØµÙ",
                task_default: "Ù…Ù‡Ù…Ø©",
                task_desc_required: "ÙˆØµÙ Ø§Ù„Ù…Ù‡Ù…Ø© Ù…Ø·Ù„ÙˆØ¨",
                task_date_required: "ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù‡Ù…Ø© Ù…Ø·Ù„ÙˆØ¨",
                task_date_invalid: "ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù‡Ù…Ø© ØºÙŠØ± ØµØ§Ù„Ø­",
                task_employee_required: "Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨",
                new_task: "Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©",
                task_assigned_to: "ØªÙ… ØªØ¹ÙŠÙŠÙ† Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù€",
                upcoming_task: "Ù…Ù‡Ù…Ø© Ù‚Ø§Ø¯Ù…Ø©",
                you_have_task_tomorrow: "Ù„Ø¯ÙŠÙƒ Ù…Ù‡Ù…Ø© ØºØ¯Ø§Ù‹:",
                leaveType: "Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„Ø©",
                msg_template: "ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø¯Ø§Ø±ÙŠ: ",
                pending: "Ù…Ø¹Ù„Ù‚",
                done: "ØªÙ…",
                approved: "Ù…Ù‚Ø¨ÙˆÙ„",
                startTime: "ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡",
                endTime: "ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡",
                breakDuration: "Ù…Ø¯Ø© Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©",
                workSchedule: "Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„"
            },
            de: {
                dashboard: "Dashboard",
                vehicles: "Fuhrparkmanagement",
                employees: "Personalverwaltung",
                tasks: "Aufgaben",
                salaries: "GehÃ¤lter",
                bonuses: "Boni",
                leaves: "Urlaub",
                issues: "Probleme & Beschwerden",
                alerts: "WhatsApp Alerts",
                cancel: "Abbrechen",
                save: "Speichern",
                add: "Neu hinzufÃ¼gen",
                name: "Mitarbeitername",
                phone: "Telefonnummer",
                role: "Position",
                plate: "Kennzeichen",
                km: "Kilometerstand",
                lastOil: "Letzter Ã–lwechsel",
                oilLimit: "Ã–l-Intervall",
                oilRem: "Verbleibend",
                maintenance: "Wartung",
                driver: "Fahrer",
                stops: "Route / Stopps",
                date: "Datum & Zeit",
                status: "Status",
                actions: "Aktionen",
                desc: "Beschreibung",
                amount: "Betrag",
                type: "Typ",
                bonus: "Bonus (+)",
                salary: "Gehalt",
                deduction: "Abzug (-)",
                no_description: "Keine Beschreibung",
                task_default: "Aufgabe",
                task_desc_required: "Aufgabenbeschreibung erforderlich",
                task_date_required: "Aufgabendatum erforderlich",
                task_date_invalid: "UngÃ¼ltiges Aufgabendatum",
                task_employee_required: "ZustÃ¤ndiger Mitarbeiter erforderlich",
                new_task: "Neue Aufgabe",
                task_assigned_to: "Neue Aufgabe zugewiesen an",
                upcoming_task: "Bevorstehende Aufgabe",
                you_have_task_tomorrow: "Sie haben morgen eine Aufgabe:",
                leaveType: "Urlaubstyp",
                msg_template: "Info: ",
                pending: "Offen",
                done: "Erledigt",
                approved: "Genehmigt"
            }
        };

        // --- Database & State ---
        let currentLang = 'ar';
        let db = {
            employees: [],
            tasks: [],
            salaries: [],
            leaves: [],
            issues: [],
            vehicles: [],
            transactions: [],
            notifications: [],
            workSchedule: []
        };

        // Initialize Data if Empty
        if (localStorage.getItem('hrFleetDb_v2')) {
            db = JSON.parse(localStorage.getItem('hrFleetDb_v2'));
        } else {
            // Demo Data with enhanced structure
            db.employees = [
                { id: 1, name: "Ø¹Ù„ÙŠ Ø­Ø³Ù†", role: "Ø³Ø§Ø¦Ù‚", phone: "49176000000", email: "ali@example.com", address: "Ø¨Ø±Ù„ÙŠÙ†", licenseNumber: "DE123456", licenseExpiry: "2025-12-31" },
                { id: 2, name: "Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯", role: "Ø³Ø§Ø¦Ù‚", phone: "49176000001", email: "ahmed@example.com", address: "Ù…ÙŠÙˆÙ†ÙŠØ®", licenseNumber: "DE654321", licenseExpiry: "2025-11-30" }
            ];
            
            db.vehicles = [
                { id: 1, plate: "B-AB123", driverId: 1, km: 150000, lastOil: 145000, oilLimit: 10000, model: "Mercedes Sprinter", year: 2020, insuranceExpiry: "2025-06-30" },
                { id: 2, plate: "B-CD456", driverId: 2, km: 120000, lastOil: 115000, oilLimit: 10000, model: "Volkswagen Crafter", year: 2021, insuranceExpiry: "2025-08-15" }
            ];
            
            db.transactions = [
                { id: 1, employeeId: 1, type: "bonus", amount: 200, description: "Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù…ØªØ§Ø²", date: "2024-01-15" },
                { id: 2, employeeId: 2, type: "salary", amount: 2500, description: "Ø±Ø§ØªØ¨ Ø´Ù‡Ø± ÙŠÙ†Ø§ÙŠØ±", date: "2024-01-31" }
            ];
            
            db.workSchedule = [
                { id: 1, employeeId: 1, date: "2024-01-15", startTime: "08:00", endTime: "17:00", breakDuration: 60, status: "completed" },
                { id: 2, employeeId: 2, date: "2024-01-16", startTime: "09:00", endTime: "18:00", breakDuration: 60, status: "scheduled" }
            ];
        }

        const saveData = () => {
            localStorage.setItem('hrFleetDb_v2', JSON.stringify(db));
            renderView();
        };

        // --- Enhanced Date Functions ---
        const formatDateISO = (date) => {
            return dateFns.format(new Date(date), 'yyyy-MM-dd');
        };

        const formatDateTimeISO = (date) => {
            return dateFns.format(new Date(date), 'yyyy-MM-dd HH:mm:ss');
        };

        const formatDateLocalized = (date) => {
            // Use Gregorian calendar format (English) for all languages
            return new Date(date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        };

        const formatDateTimeLocalized = (date) => {
            // Use Gregorian calendar format (English) for all languages
            return new Date(date).toLocaleString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        };

        const isValidDate = (dateString) => {
            const date = new Date(dateString);
            return date instanceof Date && !isNaN(date);
        };

        const isFutureDate = (dateString) => {
            return new Date(dateString) > new Date();
        };

        // --- Validation Functions ---
        const validatePhone = (phone) => {
            const phoneRegex = /^[\+]?[0-9]{10,15}$/;
            return phoneRegex.test(phone);
        };

        const validateEmail = (email) => {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        };

        const validateRequired = (value) => {
            return value && value.trim().length > 0;
        };

        const validateNumber = (value) => {
            return !isNaN(value) && value >= 0;
        };

        // --- Helpers ---
        const formatDate = (iso) => {
            if(!iso) return '';
            const d = new Date(iso);
            return d.toLocaleDateString(currentLang=='ar'?'ar-EG':'de-DE') + ' ' + d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        };

        const updateClock = () => {
            const now = new Date();
            document.getElementById('current-date').innerText = formatDateTimeLocalized(now);
        };
        setInterval(updateClock, 1000);

        // --- Notification System ---
        const addNotification = (title, message, type = 'info', employeeId = null) => {
            const notification = {
                id: Date.now(),
                title,
                message,
                type,
                employeeId,
                date: new Date().toISOString(),
                read: false
            };
            db.notifications.unshift(notification);
            updateNotificationBadge();
            saveData();
        };

        const updateNotificationBadge = () => {
            const unreadCount = db.notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notification-count');
            if (badge) {
                badge.textContent = unreadCount;
                badge.style.display = unreadCount > 0 ? 'flex' : 'none';
            }
        };

        const toggleNotifications = () => {
            const panel = document.getElementById('notification-panel');
            if (panel.style.display === 'block') {
                panel.style.display = 'none';
            } else {
                panel.style.display = 'block';
                renderNotifications();
            }
        };

        const renderNotifications = () => {
            const list = document.getElementById('notification-list');
            const notifications = db.notifications.slice(0, 10);
            
            list.innerHTML = notifications.map(notification => `
                <div class="notification-item" onclick="markNotificationRead(${notification.id})">
                    <div style="font-weight: bold; margin-bottom: 5px;">${notification.title}</div>
                    <div style="font-size: 0.9rem; color: #666;">${notification.message}</div>
                    <div style="font-size: 0.8rem; color: #999; margin-top: 5px;">
                        ${formatDateTimeLocalized(notification.date)}
                    </div>
                </div>
            `).join('');
        };

        const markNotificationRead = (notificationId) => {
            const notification = db.notifications.find(n => n.id === notificationId);
            if (notification) {
                notification.read = true;
                updateNotificationBadge();
                saveData();
            }
        };

        // --- Calendar Functions ---
        const generateCalendar = (month = new Date().getMonth(), year = new Date().getFullYear()) => {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            const days = [];
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < startingDayOfWeek; i++) {
                days.push(null);
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const hasEvent = db.tasks.some(task => {
                    const taskDate = new Date(task.date);
                    return taskDate.toDateString() === date.toDateString();
                });
                
                days.push({
                    day,
                    date,
                    isToday: date.toDateString() === new Date().toDateString(),
                    hasEvent
                });
            }
            
            return days;
        };

        const renderCalendar = () => {
            const now = new Date();
            const month = now.getMonth();
            const year = now.getFullYear();
            const monthNames = currentLang === 'ar' ? 
                ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'] :
                ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            
            const days = generateCalendar(month, year);
            const dayNames = currentLang === 'ar' ? 
                ['Ø£Ø­Ø¯', 'Ø¥Ø«Ù†ÙŠÙ†', 'Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø®Ù…ÙŠØ³', 'Ø¬Ù…Ø¹Ø©', 'Ø³Ø¨Øª'] :
                ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
            
            return `
                <div class="calendar-container">
                    <div class="calendar-header">
                        <h3>${monthNames[month]} ${year}</h3>
                        <div>
                            <button class="btn btn-sm" onclick="changeMonth(-1)"><</button>
                            <button class="btn btn-sm" onclick="changeMonth(1)">></button>
                        </div>
                    </div>
                    <div class="calendar-grid">
                        ${dayNames.map(day => `<div style="font-weight: bold; text-align: center; padding: 10px;">${day}</div>`).join('')}
                        ${days.map(day => {
                            if (!day) return '<div></div>';
                            const classes = ['calendar-day'];
                            if (day.isToday) classes.push('today');
                            if (day.hasEvent) classes.push('has-event');
                            return `<div class="${classes.join(' ')}" onclick="selectDate('${day.date.toISOString()}')">${day.day}</div>`;
                        }).join('')}
                    </div>
                </div>
            `;
        };

        // --- Report Generation ---
        const generateReports = () => {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            // Monthly statistics
            const monthlyTasks = db.tasks.filter(task => {
                const taskDate = new Date(task.date);
                return taskDate.getMonth() === currentMonth && taskDate.getFullYear() === currentYear;
            });
            
            const completedTasks = monthlyTasks.filter(task => task.status === 'done').length;
            const pendingTasks = monthlyTasks.filter(task => task.status !== 'done').length;
            
            // Driver performance
            const driverStats = {};
            db.employees.forEach(employee => {
                if (employee.role === 'Ø³Ø§Ø¦Ù‚' || employee.role === 'Driver') {
                    const driverTasks = monthlyTasks.filter(task => task.employeeId === employee.id);
                    driverStats[employee.name] = {
                        total: driverTasks.length,
                        completed: driverTasks.filter(task => task.status === 'done').length,
                        pending: driverTasks.filter(task => task.status !== 'done').length
                    };
                }
            });
            
            return {
                monthlyTasks: monthlyTasks.length,
                completedTasks,
                pendingTasks,
                completionRate: monthlyTasks.length > 0 ? Math.round((completedTasks / monthlyTasks.length) * 100) : 0,
                driverStats
            };
        };

        const renderReports = () => {
            const stats = generateReports();
            
            return `
                <div class="report-container">
                    <h3><i class="fas fa-chart-bar"></i> ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h3>
                    <div class="report-grid">
                        <div class="report-card">
                            <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…</h4>
                            <div class="value">${stats.monthlyTasks}</div>
                        </div>
                        <div class="report-card">
                            <h4>Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</h4>
                            <div class="value">${stats.completedTasks}</div>
                        </div>
                        <div class="report-card">
                            <h4>Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h4>
                            <div class="value">${stats.pendingTasks}</div>
                        </div>
                        <div class="report-card">
                            <h4>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</h4>
                            <div class="value">${stats.completionRate}%</div>
                        </div>
                    </div>
                </div>
                <div class="report-container">
                    <h3><i class="fas fa-users"></i> Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ø³Ø§Ø¦Ù‚</th>
                                <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…</th>
                                <th>Ù…ÙƒØªÙ…Ù„Ø©</th>
                                <th>Ù…Ø¹Ù„Ù‚Ø©</th>
                                <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(stats.driverStats).map(([name, stats]) => `
                                <tr>
                                    <td><strong>${name}</strong></td>
                                    <td>${stats.total}</td>
                                    <td><span class="tag-green">${stats.completed}</span></td>
                                    <td><span class="tag-yellow">${stats.pending}</span></td>
                                    <td>${stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        };

        // --- View Logic ---
        let currentView = 'dashboard';

        function navigate(view) {
            currentView = view;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.nav-item[onclick="navigate('${view}')"]`).classList.add('active');
            renderView();
        }

        function renderView() {
            const container = document.getElementById('content');
            const t = translations[currentLang];
            document.getElementById('page-header').innerText = t[currentView];
            updateClock();

            let html = '';

            // 1. Dashboard
            if (currentView === 'dashboard') {
                const issuesCount = db.issues.length;
                const tasksPending = db.tasks.filter(t => t.status !== 'done').length;
                const oilAlerts = db.vehicles.filter(v => (parseInt(v.lastOil)+parseInt(v.oilLimit)) - parseInt(v.km) < 1000).length;

                html = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div><h3>${db.employees.length}</h3><p>${t.employees}</p></div>
                            <i class="fa-solid fa-users fa-2x" style="color:#cfe2ff"></i>
                        </div>
                        <div class="stat-card" style="border-bottom-color: ${oilAlerts > 0 ? '#dc3545' : '#198754'}">
                            <div><h3>${oilAlerts}</h3><p style="color:${oilAlerts > 0 ? 'red':''}">Oil Alerts</p></div>
                            <i class="fa-solid fa-triangle-exclamation fa-2x" style="color:${oilAlerts > 0 ? '#f8d7da':'#d1e7dd'}"></i>
                        </div>
                        <div class="stat-card">
                            <div><h3>${tasksPending}</h3><p>${t.pending}</p></div>
                            <i class="fa-solid fa-clipboard-list fa-2x" style="color:#fff3cd"></i>
                        </div>
                        <div class="stat-card">
                            <div><h3>${issuesCount}</h3><p>${t.issues}</p></div>
                            <i class="fa-solid fa-bug fa-2x" style="color:#e2e3e5"></i>
                        </div>
                    </div>
                    ${renderCalendar()}
                    ${renderReports()}
                    <div class="card">
                        <h3><i class="fa-brands fa-whatsapp" style="color:#25D366"></i> Ø¥Ø¬Ø±Ø§Ø¡ Ø³Ø±ÙŠØ¹</h3>
                        <p>Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ Ù„Ù„Ù…Ø¯ÙŠØ± ÙŠØ´Ù…Ù„ Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</p>
                        <button class="btn btn-whatsapp" onclick="sendDailyReport()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¢Ù†</button>
                    </div>
                `;
            }

            // 2. Vehicles
            else if (currentView === 'vehicles') {
                html = `<div style="text-align:end; margin-bottom:15px;"><button class="btn btn-primary" onclick="openModal('vehicle')"><i class="fa-solid fa-plus"></i> ${t.add}</button></div>
                <div class="card"><table><thead><tr>
                    <th>${t.plate}</th><th>${t.driver}</th><th>${t.km}</th><th>${t.oilRem}</th><th>${t.stops}</th><th>${t.date}</th><th>${t.actions}</th>
                </tr></thead><tbody>
                ${db.vehicles.map(v => {
                    const drv = db.employees.find(e => e.id == v.driverId) || {name: '-'};
                    const rem = (parseInt(v.lastOil)+parseInt(v.oilLimit)) - parseInt(v.km);
                    return `<tr>
                        <td><strong>${v.plate}</strong></td>
                        <td>${drv.name}</td>
                        <td>${v.km}</td>
                        <td><span class="status-tag ${rem < 1000 ? 'tag-red' : 'tag-green'}">${rem} km</span></td>
                        <td>${v.stops || '-'}</td>
                        <td><span class="time-badge">${formatDate(v.updated)}</span></td>
                        <td><button class="btn btn-danger btn-sm" onclick="del('vehicles', ${v.id})"><i class="fa-solid fa-trash"></i></button></td>
                    </tr>`
                }).join('')}</tbody></table></div>`;
            }

            // 3. Employees
            else if (currentView === 'employees') {
                html = `<div style="text-align:end; margin-bottom:15px;"><button class="btn btn-primary" onclick="openModal('employee')"><i class="fa-solid fa-plus"></i> ${t.add}</button></div>
                <div class="card"><table><thead><tr><th>${t.name}</th><th>${t.role}</th><th>${t.phone}</th><th>${t.actions}</th></tr></thead><tbody>
                ${db.employees.map(e => `<tr>
                    <td><strong>${e.name}</strong></td><td>${e.role}</td><td>${e.phone}</td>
                    <td>
                        <button class="btn btn-whatsapp btn-sm" onclick="wa('${e.phone}', 'Hello')"><i class="fa-brands fa-whatsapp"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="del('employees', ${e.id})"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`).join('')}</tbody></table></div>`;
            }

            // 4. Tasks
            else if (currentView === 'tasks') {
                html = `<div style="text-align:end; margin-bottom:15px;"><button class="btn btn-primary" onclick="openModal('task')"><i class="fa-solid fa-plus"></i> ${t.add}</button></div>
                <div class="card"><table><thead><tr><th>${t.desc}</th><th>${t.name}</th><th>${t.status}</th><th>${t.date}</th><th>${t.actions}</th></tr></thead><tbody>
                ${db.tasks.map(tsk => {
                    const emp = db.employees.find(e => e.id == tsk.employeeId) || {name: '-', phone: ''};
                    return `<tr>
                        <td>${tsk.description || tsk.title || t.no_description}</td>
                        <td>${emp.name}</td>
                        <td><span class="status-tag ${tsk.status=='done'?'tag-green':'tag-yellow'}">${tsk.status=='done'?t.done:t.pending}</span></td>
                        <td><span class="time-badge">${formatDateLocalized(tsk.date)}</span></td>
                        <td>
                             <button class="btn btn-sm" style="background:#e9ecef" onclick="toggleTask(${tsk.id})"><i class="fa-solid fa-check"></i></button>
                             <button class="btn btn-whatsapp btn-sm" onclick="wa('${emp.phone}', '${t.msg_template} ${tsk.description || tsk.title || t.task_default}')"><i class="fa-brands fa-whatsapp"></i></button>
                             <button class="btn btn-danger btn-sm" onclick="del('tasks', ${tsk.id})"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`
                }).join('')}</tbody></table></div>`;
            }

            // 5. Salaries (Fixed)
            else if (currentView === 'salaries') {
                html = `<div style="text-align:end; margin-bottom:15px;"><button class="btn btn-primary" onclick="openModal('salary')"><i class="fa-solid fa-plus"></i> ${t.add}</button></div>
                <div class="card"><table><thead><tr><th>${t.name}</th><th>${t.type}</th><th>${t.amount}</th><th>${t.date}</th><th>${t.actions}</th></tr></thead><tbody>
                ${db.salaries.filter(s => s.type !== 'bonus').map(s => {
                    const emp = db.employees.find(e => e.id == s.empId) || {name: '-'};
                    return `<tr>
                        <td>${emp.name}</td>
                        <td><span class="status-tag tag-red">${t.deduction}</span></td>
                        <td style="font-weight:bold; color:red">${s.amount}</td>
                        <td><span class="time-badge">${formatDateLocalized(s.date)}</span></td>
                        <td><button class="btn btn-danger btn-sm" onclick="del('salaries', ${s.id})"><i class="fa-solid fa-trash"></i></button></td>
                    </tr>`
                }).join('')}</tbody></table></div>`;
            }

            // 5.1 Bonuses (New Separate Section)
            else if (currentView === 'bonuses') {
                html = `<div style="text-align:end; margin-bottom:15px;"><button class="btn btn-primary" onclick="openModal('bonus')"><i class="fa-solid fa-plus"></i> ${t.add}</button></div>
                <div class="card"><table><thead><tr><th>${t.name}</th><th>${t.type}</th><th>${t.amount}</th><th>${t.date}</th><th>${t.actions}</th></tr></thead><tbody>
                ${db.salaries.filter(s => s.type === 'bonus').map(s => {
                    const emp = db.employees.find(e => e.id == s.empId) || {name: '-'};
                    return `<tr>
                        <td>${emp.name}</td>
                        <td><span class="status-tag tag-green">${t.bonus}</span></td>
                        <td style="font-weight:bold; color:green">${s.amount}</td>
                        <td><span class="time-badge">${formatDateLocalized(s.date)}</span></td>
                        <td><button class="btn btn-danger btn-sm" onclick="del('salaries', ${s.id})"><i class="fa-solid fa-trash"></i></button></td>
                    </tr>`
                }).join('')}</tbody></table></div>`;
            }

            // 6. Issues (Fixed)
            else if (currentView === 'issues') {
                html = `<div style="text-align:end; margin-bottom:15px;"><button class="btn btn-primary" onclick="openModal('issue')"><i class="fa-solid fa-plus"></i> ${t.add}</button></div>
                <div class="card"><table><thead><tr><th>${t.name}</th><th>${t.desc}</th><th>${t.date}</th><th>${t.actions}</th></tr></thead><tbody>
                ${db.issues.map(i => {
                    const emp = db.employees.find(e => e.id == i.empId) || {name: '-', phone: ''};
                    return `<tr>
                        <td>${emp.name}</td>
                        <td>${i.desc}</td>
                        <td><span class="time-badge">${formatDate(i.date)}</span></td>
                        <td>
                            <button class="btn btn-whatsapp btn-sm" onclick="wa('${emp.phone}', 'Problem: ${i.desc}')"><i class="fa-brands fa-whatsapp"></i></button>
                            <button class="btn btn-danger btn-sm" onclick="del('issues', ${i.id})"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`
                }).join('')}</tbody></table></div>`;
            }

            // 7. Work Schedule
            else if (currentView === 'schedule') {
                html = `<div style="text-align:end; margin-bottom:15px;"><button class="btn btn-primary" onclick="openModal('schedule')"><i class="fa-solid fa-plus"></i> ${t.add}</button></div>
                <div class="card"><table><thead><tr><th>${t.name}</th><th>${t.date}</th><th>${t.startTime}</th><th>${t.endTime}</th><th>${t.breakDuration}</th><th>${t.status}</th><th>${t.actions}</th></tr></thead><tbody>
                ${db.workSchedule.map(schedule => {
                    const emp = db.employees.find(e => e.id == schedule.employeeId) || {name: '-'};
                    return `<tr>
                        <td>${emp.name}</td>
                        <td><span class="time-badge">${formatDate(schedule.date)}</span></td>
                        <td>${schedule.startTime}</td>
                        <td>${schedule.endTime}</td>
                        <td>${schedule.breakDuration} Ø¯Ù‚ÙŠÙ‚Ø©</td>
                        <td><span class="status-tag ${schedule.status === 'completed' ? 'tag-green' : 'tag-yellow'}">${schedule.status}</span></td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="del('workSchedule', ${schedule.id})"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`
                }).join('')}</tbody></table></div>`;
            }

            // 8. Leaves
            else if (currentView === 'leaves') {
                html = `<div style="text-align:end; margin-bottom:15px;"><button class="btn btn-primary" onclick="openModal('leave')"><i class="fa-solid fa-plus"></i> ${t.add}</button></div>
                <div class="card"><table><thead><tr><th>${t.name}</th><th>${t.leaveType}</th><th>${t.date}</th><th>${t.actions}</th></tr></thead><tbody>
                ${db.leaves.map(l => {
                    const emp = db.employees.find(e => e.id == l.empId) || {name: '-'};
                    return `<tr>
                        <td>${emp.name}</td>
                        <td>${l.type}</td>
                        <td><span class="time-badge">${formatDate(l.date)}</span></td>
                        <td><button class="btn btn-danger btn-sm" onclick="del('leaves', ${l.id})"><i class="fa-solid fa-trash"></i></button></td>
                    </tr>`
                }).join('')}</tbody></table></div>`;
            }

            // 8. Alerts View
            else if (currentView === 'alerts') {
                html = `
                    <div class="card">
                        <h3>WhatsApp Center</h3>
                        <div style="margin-top:20px; display:flex; gap:10px;">
                            <select id="wa-emp" class="form-control" style="width:250px;">
                                ${db.employees.map(e => `<option value="${e.phone}">${e.name}</option>`).join('')}
                            </select>
                            <input id="wa-msg" class="form-control" placeholder="Message...">
                            <button class="btn btn-whatsapp" onclick="sendCustomWa()">Send <i class="fa-solid fa-paper-plane"></i></button>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // --- Logic ---
        function wa(phone, text) {
            if(!phone) return alert('No Phone Number');
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(text)}`, '_blank');
        }

        function sendCustomWa() {
            const p = document.getElementById('wa-emp').value;
            const m = document.getElementById('wa-msg').value;
            wa(p, m);
        }

        function sendDailyReport() {
            const today = new Date();
            const todayTasks = db.tasks.filter(task => {
                const taskDate = new Date(task.date);
                return taskDate.toDateString() === today.toDateString();
            });
            
            const pendingTasks = db.tasks.filter(task => task.status !== 'done');
            const issues = db.issues.filter(issue => !issue.resolved);
            
            let report = `ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ - ${formatDateLocalized(today)}\n\n`;
            report += `ğŸ“‹ Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ… (${todayTasks.length}):\n`;
            todayTasks.forEach(task => {
                const employee = db.employees.find(e => e.id == task.employeeId);
                report += `- ${task.description} (${employee ? employee.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}) - ${task.status}\n`;
            });
            
            report += `\nâ° Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© (${pendingTasks.length}):\n`;
            pendingTasks.slice(0, 5).forEach(task => {
                const employee = db.employees.find(e => e.id == task.employeeId);
                report += `- ${task.description} (${employee ? employee.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'})\n`;
            });
            
            report += `\nâš ï¸ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠØ© (${issues.length}):\n`;
            issues.slice(0, 5).forEach(issue => {
                report += `- ${issue.description}\n`;
            });
            
            // Add notification for report generation
            addNotification('ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨', 'success');
            
            alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨!\n\n' + report);
        }

        function del(col, id) {
            if(confirm('Delete?')) {
                db[col] = db[col].filter(x => x.id !== id);
                saveData();
            }
        }

        function toggleTask(id) {
            const t = db.tasks.find(x => x.id === id);
            t.status = t.status === 'done' ? 'pending' : 'done';
            saveData();
        }

        // --- Modal Logic (FIXED) ---
        let currentModalType = '';

        function openModal(type) {
            currentModalType = type;
            document.getElementById('modal').classList.add('active');
            const t = translations[currentLang];
            const empOpts = db.employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
            
            let html = '';

            if (type === 'employee') {
                html = `
                    <div class="form-group"><label>${t.name}</label><input name="name" class="form-control" required></div>
                    <div class="form-group"><label>${t.role}</label><input name="role" class="form-control" required></div>
                    <div class="form-group"><label>${t.phone}</label><input name="phone" placeholder="4915..." class="form-control" required></div>
                `;
            } else if (type === 'vehicle') {
                html = `
                    <div class="form-group"><label>${t.plate}</label><input name="plate" class="form-control" required></div>
                    <div class="form-group"><label>${t.driver}</label><select name="driverId" class="form-control">${empOpts}</select></div>
                    <div class="form-group"><label>${t.km}</label><input name="km" type="number" class="form-control" required></div>
                    <div class="form-group"><label>${t.lastOil}</label><input name="lastOil" type="number" class="form-control" required></div>
                    <div class="form-group"><label>${t.oilLimit}</label><input name="oilLimit" type="number" value="10000" class="form-control"></div>
                    <div class="form-group"><label>${t.stops}</label><input name="stops" class="form-control"></div>
                `;
            } else if (type === 'task') {
                html = `
                    <div class="form-group"><label>${t.desc}</label><input name="description" class="form-control" required></div>
                    <div class="form-group"><label>${t.name}</label><select name="employeeId" class="form-control">${empOpts}</select></div>
                    <div class="form-group"><label>${t.date}</label><input name="date" type="date" class="form-control" required></div>
                `;
            } else if (type === 'salary') {
                html = `
                    <div class="form-group"><label>${t.name}</label><select name="empId" class="form-control">${empOpts}</select></div>
                    <div class="form-group"><label>${t.type}</label><select name="type" class="form-control">
                        <option value="deduction">${t.deduction}</option>
                        <option value="salary">${t.salary}</option>
                    </select></div>
                    <div class="form-group"><label>${t.amount}</label><input name="amount" type="number" class="form-control" required></div>
                `;
            } else if (type === 'bonus') {
                html = `
                    <div class="form-group"><label>${t.name}</label><select name="empId" class="form-control">${empOpts}</select></div>
                    <div class="form-group"><label>${t.amount}</label><input name="amount" type="number" class="form-control" required></div>
                    <div class="form-group"><label>${t.date}</label><input name="date" type="date" class="form-control" required></div>
                `;
            } else if (type === 'issue') {
                html = `
                    <div class="form-group"><label>${t.name}</label><select name="empId" class="form-control">${empOpts}</select></div>
                    <div class="form-group"><label>${t.desc}</label><textarea name="desc" class="form-control" rows="3" required></textarea></div>
                `;
            } else if (type === 'leave') {
                html = `
                    <div class="form-group"><label>${t.name}</label><select name="empId" class="form-control">${empOpts}</select></div>
                    <div class="form-group"><label>${t.leaveType}</label><input name="type" class="form-control" required></div>
                `;
            } else if (type === 'schedule') {
                html = `
                    <div class="form-group"><label>${t.name}</label><select name="employeeId" class="form-control">${empOpts}</select></div>
                    <div class="form-group"><label>${t.date}</label><input name="date" type="date" class="form-control" required></div>
                    <div class="form-group"><label>${t.startTime}</label><input name="startTime" type="time" class="form-control" required></div>
                    <div class="form-group"><label>${t.endTime}</label><input name="endTime" type="time" class="form-control" required></div>
                    <div class="form-group"><label>${t.breakDuration}</label><input name="breakDuration" type="number" placeholder="60" class="form-control" required></div>
                    <div class="form-group"><label>${t.status}</label><select name="status" class="form-control">
                        <option value="scheduled">Ù…Ø¬Ø¯ÙˆÙ„</option>
                        <option value="completed">Ù…ÙƒØªÙ…Ù„</option>
                        <option value="cancelled">Ù…Ù„ØºÙ‰</option>
                    </select></div>
                `;
            }

            document.getElementById('modal-fields').innerHTML = html;
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        // --- Enhanced Form Validation ---
        const validateFormData = (formData, formType) => {
            const errors = [];
            
            switch (formType) {
                case 'employee':
                    if (!validateRequired(formData.name)) errors.push('Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨');
                    if (!validateRequired(formData.role)) errors.push('Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ù…Ø·Ù„ÙˆØ¨');
                    if (!validatePhone(formData.phone)) errors.push('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ§Ù„Ø­');
                    break;
                    
                case 'vehicle':
                    if (!validateRequired(formData.plate)) errors.push('Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø© Ù…Ø·Ù„ÙˆØ¨');
                    if (!validateRequired(formData.driverId)) errors.push('Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù…Ø·Ù„ÙˆØ¨');
                    if (!validateNumber(formData.km)) errors.push('Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù…Ø§Ù‹ Ù…ÙˆØ¬Ø¨Ø§Ù‹');
                    if (!validateNumber(formData.lastOil)) errors.push('ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØºÙŠÙŠØ± Ø²ÙŠØª ØºÙŠØ± ØµØ§Ù„Ø­');
                    break;
                    
                case 'task':
                    if (!validateRequired(formData.description)) errors.push(t.task_desc_required);
                    if (!validateRequired(formData.date)) errors.push(t.task_date_required);
                    if (!isValidDate(formData.date)) errors.push(t.task_date_invalid);
                    if (!validateRequired(formData.employeeId)) errors.push(t.task_employee_required);
                    break;
                    
                case 'salary':
                    if (!validateRequired(formData.employeeId)) errors.push('Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ø·Ù„ÙˆØ¨');
                    if (!validateNumber(formData.amount)) errors.push('Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù…Ø§Ù‹ Ù…ÙˆØ¬Ø¨Ø§Ù‹');
                    if (!validateRequired(formData.type)) errors.push('Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ø·Ù„ÙˆØ¨');
                    break;
                    
                case 'schedule':
                    if (!validateRequired(formData.employeeId)) errors.push('Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ø·Ù„ÙˆØ¨');
                    if (!validateRequired(formData.date)) errors.push('Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ø·Ù„ÙˆØ¨');
                    if (!isValidDate(formData.date)) errors.push('Ø§Ù„ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ§Ù„Ø­');
                    if (!validateRequired(formData.startTime)) errors.push('ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ø·Ù„ÙˆØ¨');
                    if (!validateRequired(formData.endTime)) errors.push('ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ø·Ù„ÙˆØ¨');
                    if (!validateNumber(formData.breakDuration)) errors.push('Ù…Ø¯Ø© Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø±Ù‚Ù…Ø§Ù‹');
                    break;
            }
            
            return errors;
        };

        const showValidationErrors = (errors) => {
            if (errors.length > 0) {
                alert('ÙŠØ±Ø¬Ù‰ ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªØ§Ù„ÙŠØ©:\n' + errors.join('\n'));
                return false;
            }
            return true;
        };

        // --- Enhanced Form Submission ---
        const handleFormSubmit = (formData, formType) => {
            const errors = validateFormData(formData, formType);
            if (!showValidationErrors(errors)) {
                return false;
            }
            
            // Add timestamps and validation
            formData.createdAt = new Date().toISOString();
            formData.updatedAt = new Date().toISOString();
            
            // Create notification for important events
            if (formType === 'task') {
                const employee = db.employees.find(e => e.id == formData.employeeId);
                if (employee) {
                    addNotification(
                        t.new_task,
                        `${t.task_assigned_to} ${employee.name}`,
                        'info',
                        formData.employeeId
                    );
                }
            }
            
            return true;
        };

        // --- Calendar Navigation ---
        let currentCalendarMonth = new Date().getMonth();
        let currentCalendarYear = new Date().getFullYear();

        const changeMonth = (direction) => {
            currentCalendarMonth += direction;
            if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            } else if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            }
            renderView();
        };

        const selectDate = (dateString) => {
            const selectedDate = new Date(dateString);
            const tasksOnDate = db.tasks.filter(task => {
                const taskDate = new Date(task.date);
                return taskDate.toDateString() === selectedDate.toDateString();
            });
            
            if (tasksOnDate.length > 0) {
                let message = `Ø§Ù„Ù…Ù‡Ø§Ù… ÙÙŠ ${formatDateLocalized(selectedDate)}:\n`;
                tasksOnDate.forEach(task => {
                    const employee = db.employees.find(e => e.id == task.employeeId);
                    message += `- ${task.description} (${employee ? employee.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'})\n`;
                });
                alert(message);
            }
        };

        // --- Automatic Notifications ---
        const checkUpcomingEvents = () => {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const nextWeek = new Date(now);
            nextWeek.setDate(nextWeek.getDate() + 7);
            
            // Check for upcoming tasks
            db.tasks.forEach(task => {
                const taskDate = new Date(task.date);
                if (taskDate.toDateString() === tomorrow.toDateString() && task.status !== 'done') {
                    const employee = db.employees.find(e => e.id == task.employeeId);
                    if (employee) {
                        addNotification(
                            t.upcoming_task,
                            `${t.you_have_task_tomorrow} ${task.description}`,
                            'warning',
                            task.employeeId
                        );
                    }
                }
            });
            
            // Check for license expirations
            db.employees.forEach(employee => {
                if (employee.licenseExpiry) {
                    const licenseExpiry = new Date(employee.licenseExpiry);
                    const daysUntilExpiry = Math.ceil((licenseExpiry - now) / (1000 * 60 * 60 * 24));
                    
                    if (daysUntilExpiry <= 30 && daysUntilExpiry > 0) {
                        addNotification(
                            'Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø±Ø®ØµØ©',
                            `Ø±Ø®ØµØ© Ø§Ù„Ø³Ø§Ø¦Ù‚ ${employee.name} ØªÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ ${daysUntilExpiry} ÙŠÙˆÙ…`,
                            'danger'
                        );
                    }
                }
            });
            
            // Check for vehicle maintenance
            db.vehicles.forEach(vehicle => {
                const kmRemaining = (parseInt(vehicle.lastOil) + parseInt(vehicle.oilLimit)) - parseInt(vehicle.km);
                if (kmRemaining <= 1000 && kmRemaining > 0) {
                    addNotification(
                        'ØµÙŠØ§Ù†Ø© Ù‚Ø±ÙŠØ¨Ø©',
                        `Ø§Ù„Ù…Ø±ÙƒØ¨Ø© ${vehicle.plate} ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØµÙŠØ§Ù†Ø© Ø®Ù„Ø§Ù„ ${kmRemaining} ÙƒÙ…`,
                        'warning'
                    );
                }
            });
        };

        // Run checks every hour
        setInterval(checkUpcomingEvents, 3600000);
        // Run once on load
        setTimeout(checkUpcomingEvents, 5000);

        document.getElementById('modal-form').onsubmit = (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const data = Object.fromEntries(fd.entries());
            data.id = Date.now();
            data.date = new Date().toISOString(); // Timestamp

            if (currentModalType === 'employee') db.employees.push(data);
            else if (currentModalType === 'vehicle') { data.updated = data.date; db.vehicles.push(data); }
            else if (currentModalType === 'task') { data.status = 'pending'; db.tasks.push(data); }
            else if (currentModalType === 'salary') { data.type = data.type || 'salary'; db.salaries.push(data); }
            else if (currentModalType === 'bonus') { data.type = 'bonus'; db.salaries.push(data); }
            else if (currentModalType === 'issue') db.issues.push(data);
            else if (currentModalType === 'leave') db.leaves.push(data);

            saveData();
            closeModal();
        };

        function toggleLanguage() {
            currentLang = currentLang === 'ar' ? 'de' : 'ar';
            document.documentElement.lang = currentLang;
            document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            document.body.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            renderView();
        }

        // Init
        renderView();

    </script>
</body>
</html>